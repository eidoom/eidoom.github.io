<!DOCTYPE HTML>
<html>
	<head>
		<title>Bonding ethernet interfaces with systemd-networkd &middot; Ryan Moodie</title>
		<link rel="shortcut icon" href="//eidoom.github.io//favicon.ico">
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="author" content="Ryan Iain Moodie">
		<meta name="description" content="Theoretical physicist">
		<meta http-equiv="content-language" content="en-gb" />

		
		<meta name="og:site_name" content="Ryan Moodie">
		<meta name="og:description" content="Theoretical physicist">
		<meta name="og:title" content="Bonding ethernet interfaces with systemd-networkd">
		<meta name="og:url" content="//eidoom.github.io/post/bonding-ethernet-interfaces-on-debian-stretch/">
		
		<meta name="og:image" content="//eidoom.github.io/images/my_avatar.jpg">
		
		

		<meta name="generator" content="Hugo 0.59.1" />

		<!--[if lte IE 8]><script src='//eidoom.github.io/js/ie/html5shiv.js'></script><![endif]-->
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="//eidoom.github.io/academicons/css/academicons.css"/>
		<link rel="stylesheet" href="//eidoom.github.io/css/main.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="//eidoom.github.io//css/ie8.css"><![endif]-->

		
		
		<link rel="stylesheet" href="//eidoom.github.io/css/custom.css">
		
	</head>

	<body id="top">
		<!-- Header -->
<header id="header">
	<a href="//eidoom.github.io/" class="image avatar"><img src="//eidoom.github.io/images/my_avatar.jpg" alt="Ryan Moodie"></a>	
	

	
</header>




		<!-- Main -->
		<div id="main">
			
	<span>
		<h1>Bonding ethernet interfaces with systemd-networkd</h1>

		<i class="fa fa-calendar"></i>&nbsp;&nbsp;
<time datetime="2019-11-02 16:36:51 &#43;0000 UTC">02-11-2019</time>&nbsp;&nbsp;


<i class="fa fa-clock-o"></i>&nbsp;&nbsp; 3 min read&nbsp;&nbsp;



    
    
        <i class="fa fa-folder"></i>&nbsp;&nbsp;
        
        <a class="article-category-link" href="//eidoom.github.io/categories/computing">computing</a>
        
        
    



   
   
       &nbsp;&nbsp;<i class="fa fa-tags"></i>&nbsp;&nbsp;
       
       <a class="article-category-link" href="//eidoom.github.io/tags/debian">debian</a>
       &middot;
       
       <a class="article-category-link" href="//eidoom.github.io/tags/linux">linux</a>
       &middot;
       
       <a class="article-category-link" href="//eidoom.github.io/tags/network">network</a>
       &middot;
       
       <a class="article-category-link" href="//eidoom.github.io/tags/server">server</a>
       &middot;
       
       <a class="article-category-link" href="//eidoom.github.io/tags/systemd">systemd</a>
       
       
   


	</span>

	<p>
	    

<h2 id="introduction">Introduction</h2>

<p>I set up my linux server to use its two ethernet interfaces in <a href="https://en.wikipedia.org/wiki/Link_aggregation#Link_Aggregation_Control_Protocol">parallel</a>.
My primary <a href="https://wiki.debian.org/Bonding#Using_systemd-networkd">reference was from the Debian wiki</a>.
My server runs Debian Buster.</p>

<h2 id="migrating-to-systemd-networkd">Migrating to systemd-networkd</h2>

<p>I used <a href="https://wiki.archlinux.org/index.php/Systemd-networkd">systemd-networkd</a> to configure the bond interface.
My system already uses <a href="https://wiki.archlinux.org/index.php/Systemd">systemd</a>, so I just had to enable systemd-networkd.</p>

<pre><code class="language-shell">sudo systemctl enable systemd-networkd
</code></pre>

<p>I also set up <a href="https://wiki.archlinux.org/index.php/Systemd-resolved">systemd-resolved</a> to <a href="https://wiki.archlinux.org/index.php/Systemd-resolved#DNS">provide name resolution</a>.</p>

<pre><code class="language-shell">sudo systemctl enable systemd-resolved
ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf
</code></pre>

<p>Over the years, I have used various networking solutions on this machine.
Most recently, I set up <a href="https://en.wikipedia.org/wiki/ConnMan">connman</a> to <a href="https://wiki.archlinux.org/index.php/ConnMan#Connecting_to_eduroam_(802.1X)">connect wirelessly to eduroam</a> at my previous residence.
I disabled all previous configurations.</p>

<pre><code>sudo mv /etc/network/interfaces /etc/network/interfaces.backup
sudo apt remove connman
sudo apt remove wpasupplicant
sudo systemctl disable dhcpcd
</code></pre>

<h2 id="configure-bond-device">Configure bond device</h2>

<p>The configuration files for systemd-networkd use <a href="https://wiki.archlinux.org/index.php/Systemd-networkd#Configuration_files">this syntax</a>.
First, I set up the new bond interface.</p>

<pre><code>sudo vim /etc/systemd/network/10-bond1.netdev
</code></pre>

<pre><code>[NetDev]
Name=bond1
Kind=bond

[Bond]
Mode=802.3ad
</code></pre>

<p>I chose the <code>802.3ad</code> mode to double the throughput of my server&rsquo;s network interface.
Note that this increase in bandwidth does not apply to a single connection: each connection still uses a single ethernet interface.
However, multiple connections are balanced over the two physical interfaces.</p>

<h2 id="add-interfaces-to-bond">Add interfaces to bond</h2>

<p>Then I slaved the ethernet interfaces to the bond.</p>

<pre><code>sudo vim /etc/systemd/network/10-bond1.network
</code></pre>

<pre><code>[Match]
Name=enp*

[Network]
Bond=bond1
</code></pre>

<h2 id="assign-ip-to-bond">Assign IP to bond</h2>

<p>Finally, I assigned a static IP address to the bond interface.</p>

<pre><code>sudo vim /etc/systemd/network/10-enp_.network
</code></pre>

<pre><code>[Match]
Name=bond1

[Network]
BindCarrier=enp3s0 enp0s31f6
Address=192.168.1.2
Gateway=192.168.1.1
DNS=192.168.1.1
</code></pre>

<h2 id="apply-and-check">Apply and check</h2>

<p>I applied the new configuration with a reboot</p>

<pre><code>sudo reboot
</code></pre>

<p>Further applications of new test configurations (the above configuration being the final such iteration) were performed by restarting systemd-networkd</p>

<pre><code class="language-shell">sudo systemctl restart systemd-networkd
</code></pre>

<p>Checking the network configuration,</p>

<pre><code>ip a
</code></pre>

<pre><code>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp3s0: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master bond1 state UP group default qlen 1000
    link/ether da:0e:cb:14:25:5d brd ff:ff:ff:ff:ff:ff
3: enp0s31f6: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master bond1 state UP group default qlen 1000
    link/ether da:0e:cb:14:25:5d brd ff:ff:ff:ff:ff:ff
4: bond1: &lt;BROADCAST,MULTICAST,MASTER,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether da:0e:cb:14:25:5d brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.2/24 brd 192.168.1.255 scope global bond1
       valid_lft forever preferred_lft forever
    inet6 fdaa:bbcc:ddee:0:d80e:cbff:fe14:255d/64 scope global dynamic mngtmpaddr noprefixroute 
       valid_lft 2006054619sec preferred_lft 2006054619sec
    inet6 fe80::d80e:cbff:fe14:255d/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre>

<p>I was happy to see that</p>

<table>
<thead>
<tr>
<th>interface</th>
<th>UP</th>
<th>SLAVE</th>
<th>MASTER</th>
<th>has IP address</th>
</tr>
</thead>

<tbody>
<tr>
<td>bond1</td>
<td>y</td>
<td>n</td>
<td>y</td>
<td>y</td>
</tr>

<tr>
<td>enp*</td>
<td>y</td>
<td>y</td>
<td>n</td>
<td>n</td>
</tr>
</tbody>
</table>

<p>Also,</p>

<pre><code class="language-shell">cat /proc/net/bonding/bond1
</code></pre>

<pre><code>Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)

Bonding Mode: IEEE 802.3ad Dynamic link aggregation
Transmit Hash Policy: layer2 (0)
MII Status: up
MII Polling Interval (ms): 100
Up Delay (ms): 0
Down Delay (ms): 0

802.3ad info
LACP rate: slow
Min links: 0
Aggregator selection policy (ad_select): stable

Slave Interface: enp0s31f6
MII Status: up
Speed: 1000 Mbps
Duplex: full
Link Failure Count: 0
Permanent HW addr: d0:50:99:85:3c:b6
Slave queue ID: 0
Aggregator ID: 1
Actor Churn State: none
Partner Churn State: churned
Actor Churned Count: 0
Partner Churned Count: 1

Slave Interface: enp3s0
MII Status: up
Speed: 1000 Mbps
Duplex: full
Link Failure Count: 0
Permanent HW addr: d0:50:99:85:3c:b8
Slave queue ID: 0
Aggregator ID: 2
Actor Churn State: churned
Partner Churn State: churned
Actor Churned Count: 1
Partner Churned Count: 1
</code></pre>

<p>confirmed that the bond was working.</p>

	</p>

	

		</div>

		<!-- Footer -->
<footer id="footer">
    <a href="//eidoom.github.io/" class="signature">
        <img src="//eidoom.github.io/images/signature_invert.png" alt="Ryan Moodie">
    </a>
    <ul class="icons">
        
            <li>
                <a href="//arxiv.org/a/moodie_r_1.html" target="_blank" class="ai ai-arxiv ai-2x">
                    <span class="label">arXiv</span>
                </a>
            </li>
        
        
            <li>
                <a href="//github.com/eidoom" target="_blank" class="icon fa-github fa-lg">
                    <span class="label">GitHub</span>
                </a>
            </li>
        
        
            <li>
                <a href="//gitlab.com/eidoom" target="_blank" class="icon fa-gitlab fa-lg">
                    <span class="label">GitLab</span>
                </a>
            </li>
        
        
            <li>
                <a href="//bitbucket.com/ryanmoodie" target="_blank" class="icon fa-bitbucket fa-lg">
                    <span class="label">BitBucket</span>
                </a>
            </li>
        
    </ul>
    <ul class="copyright">
        
        <li>Design: <a href="//github.com/digitalcraftsman/hugo-strata-theme">Strata</a></li>
        
        <li>Pictures: <a href="//www.instagram.com/yazashmawi/">Yaz Ashmawi</a></li>
        
	<li><a rel="license" class="icon"  href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a></li>
    </ul>
</footer>

<!-- Scripts -->
<script src="//eidoom.github.io/js/jquery.min.js"></script>
<script src="//eidoom.github.io/js/jquery.poptrox.min.js"></script>
<script src="//eidoom.github.io/js/skel.min.js"></script>
<script src="//eidoom.github.io/js/util.js"></script>

<script src="//eidoom.github.io/js/main.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-66224969-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




	</body>
</html>
